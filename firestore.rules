rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      // Allow Read: Public (needed for Leaderboard & Login)
      allow read: if true;

      // Allow Create: Anyone can create a new account (Passport system)
      // Validation: Must have a nickname and region
      allow create: if request.resource.data.nickname is string
                   && request.resource.data.region is string
                   && request.resource.data.xp == 0; // Start with 0 XP

      // Allow Update: This is where we prevent "Glitches"
      // Since we don't have Auth, we rely on Logic Validation
      allow update: if 
        // 1. PREVENT SELF-VERIFICATION
        // The 'verified' field cannot be changed by the client.
        // It must remain the same as it was before.
        (request.resource.data.verified == resource.data.verified || (!("verified" in resource.data) && !("verified" in request.resource.data)))
        
        // 2. PREVENT XP HACKS (Massive Jumps)
        // XP can increase, but not by more than 5000 in a single sync (generous buffer for legitimate play)
        // OR XP works if it is decreasing (spending)
        && (
             request.resource.data.xp <= resource.data.xp + 5000 
             || request.resource.data.xp < resource.data.xp
           );

      // No deleting users from client
      allow delete: if false;
    }
  }
}
